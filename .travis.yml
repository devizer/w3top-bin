language: minimal
matrix:
  include:
  - name: Ubuntu 14.04 (Sys V Init)
    os: linux
    dist: trusty
  - name: Ubuntu 16.04 (SystemD)
    os: linux
    dist: xenial

script:
 - |
   function wait_for_http() {
     u="$1"; t=300; 
     printf "Waiting for [$u] during $t seconds ..."
     while [ $t -ge 0 ]; do t=$((t-1)); curl -m 1 -skf "$u" >/dev/null && printf " OK\n"; if [ $? -eq 0 ]; then return; fi; printf "."; sleep 1; done
     printf " FAIL\n";
   }
 - |
   wait_for_http "https://raw.githubusercontent.com/devizer/w3top-bin/master/public/version.txt"
   wait_for_http "https://raw.githubusercontent.com/devizer/w3top-bin/master/public/w3top-linux-x64.tar.gz.sha256"
 - |
     export HTTP_PORT=5050
     export RESPONSE_COMPRESSION=True
     export INSTALL_DIR=/opt/w3top
     script=https://raw.githubusercontent.com/devizer/w3top-bin/master/install-w3top-service.sh
     (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash
 - |
   wait_for_http "http://localhost:5050/"
 - export codename="$(lsb_release -c -s)"
 # Build fails if corresponding url or systemd unit can't be reached
 - curl -I http://localhost:5050/ >/tmp/pre-jit
 - curl -I http://localhost:5050/
 - curl http://localhost:5050/api/BriefInfo && echo ""
 - |
   if [[ $codename == xenial ]]; then 
     (sudo journalctl -u w3top.service | head -42) && sudo systemctl disable w3top.service
   else
     cat /tmp/w3top.log && cat /etc/init.d/w3top && /etc/init.d/w3top version
   fi
