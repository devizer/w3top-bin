language: minimal
matrix:
  include:
  
  - name: Ubuntu 14.04 and sqlite (Sys V Init)
    os: linux
    dist: trusty

  - name: Ubuntu 16.04 and sqlite (SystemD)
    os: linux
    dist: xenial

  - name: Ubuntu 18.04 and sqlite
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="ubuntu:18.04"
    - TEST_SCRIPT="debian_prepare && install_w3top"

  - name: Ubuntu 19.04 and sqlite
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="ubuntu:19.04"
    - TEST_SCRIPT="debian_prepare && install_w3top"

  - name: CentOS 6.6 and MySQL 5.1 (curl)
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="centos:6.6"
    - TEST_SCRIPT="mysql_51_on_centos_6 && install_w3top"

  - name: CentOS 6.6 and Postgres SQL 8.4 (wget)
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="centos:6.6"
    - TEST_SCRIPT="pg_84_on_centos_6 && centos_wget_only && install_w3top"

  - name: CentOS 6.9 and MySQL 5.1 (curl)
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="centos:6.9"
    - TEST_SCRIPT="mysql_51_on_centos_6 && install_w3top"

  - name: CentOS 6.9 and Postgres SQL 8.4 (wget)
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="centos:6.9"
    - TEST_SCRIPT="pg_84_on_centos_6 && centos_wget_only && install_w3top"

  - name: CentOS 7.0 and sqlite (wget)
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="centos:7.0.1406"
    - TEST_SCRIPT="centos_wget_only && install_w3top"

  - name: CentOS 7.6 and sqlite (curl)
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="centos:7.6.1810"
    - TEST_SCRIPT="centos_curl_only && install_w3top"

  - name: Debian 8.9 and sqlite
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="debian:8.9"
    - TEST_SCRIPT="debian_prepare && install_w3top"

  - name: Debian 9.9 and sqlite
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="debian:9.9"
    - TEST_SCRIPT="debian_prepare && install_w3top"

  - name: Debian Buster and sqlite
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="debian:buster"
    - TEST_SCRIPT="debian_prepare && install_w3top"

  - name: Fedora 27 and sqlite
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="fedora:27"
    - TEST_SCRIPT="fedora_prepare && install_w3top"

  - name: Fedora 28 and sqlite
    os: linux
    dist: xenial
    env: 
    - TEST_IMAGE="fedora:28"
    - TEST_SCRIPT="fedora_prepare && install_w3top"

before_install:
  - sudo apt-get install -y toilet

script:
 - |
   function wait_for_http() {
     u="$1"; t=300; 
     printf "Waiting for [$u] during $t seconds ..."
     while [ $t -ge 0 ]; do t=$((t-1)); curl -m 1 -skf "$u" >/dev/null && printf " OK\n"; if [ $? -eq 0 ]; then return; fi; printf "."; sleep 1; done
     printf " FAIL\n";
   }
   function travis_say() { toilet -f bigascii12 -w 120 "$1"; }
 - |
   wait_for_http "https://raw.githubusercontent.com/devizer/w3top-bin/master/public/version.txt"
   wait_for_http "https://raw.githubusercontent.com/devizer/w3top-bin/master/public/w3top-linux-x64.tar.gz.sha256"
   source /etc/os-release; travis_say "$ID $VERSION_ID"
 - |
     export HTTP_PORT=5050
     export RESPONSE_COMPRESSION=True
     export INSTALL_DIR=/opt/w3top
     script=https://raw.githubusercontent.com/devizer/w3top-bin/master/install-w3top-service.sh
     (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash
 - |
   wait_for_http "http://localhost:5050/"
 - export codename="$(lsb_release -c -s)"
 # Build fails if corresponding url or systemd unit can't be reached
 - curl -I http://localhost:5050/ >/tmp/pre-jit
 - curl -I http://localhost:5050/
 - curl http://localhost:5050/api/BriefInfo && echo ""
 - |
   if [[ $codename == xenial ]]; then 
     (sudo journalctl -u w3top.service | head -42) && sudo systemctl disable w3top.service
   else
     cat /tmp/w3top.log && cat /etc/init.d/w3top && /etc/init.d/w3top version
   fi

 - |
   if [[ "$TEST_IMAGE" != "" ]]; then
     travis_say "$TEST_IMAGE"
     docker run -d --name w3top -p "5055:5050" "$TEST_IMAGE"  bash -c "while true; do sleep 42; done"
     docker exec -t w3top bash -c "cat /etc/*release"
     chmod +x tests/w3top-tests.sh
     docker cp tests/w3top-tests.sh w3top:/w3top-tests.sh
     docker exec -t w3top bash -c "echo HOME: \$HOME; source /w3top-tests.sh; $TEST_SCRIPT && echo 'TEST FINISHED'"
     wait_for_http http://localhost:5055
     curl -I http://localhost:5055 || exit 666
   fi
